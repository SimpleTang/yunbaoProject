### 孕期陪护机器人“孕小宝” V1.0 - 技术架构设计文档**

| 文档名称 | 孕期陪护机器人“孕小宝” V1.0 技术架构设计文档 |
| :--- | :--- |
| **版本号** | **1.0 Final** |
| **创建日期** | 2025年08月05日 |
| **作者** | 您 |
| **状态** | **已归档** |

#### **1. 系统概述**

本项目旨在通过 **n8n + 本地 MySQL** 技术栈，构建一个服务于特定家庭的、高度个性化的孕期 AI 陪护机器人“孕小宝”。系统 V1.0 版本的核心是实现一个基于自然语言交互的智能问答与信息管理助理，它能够理解对话意图，自主调用数据库和图像识别等工具，为家庭成员提供精准、温暖的支持。

#### **2. 系统架构**

本系统采用了先进的**多层工作流解耦架构**，将复杂的任务拆分为独立、专一的模块，确保了系统的高可用性、可维护性和逻辑清晰性。

**系统数据流转图：**
```mermaid
graph TD
    subgraph 用户端
        A[家庭成员在飞书群/私聊中发言]
    end

    subgraph 网络与调度层
        B(ngrok 公网地址) --> C{Webhook<br>(机器人消息分发.json)}
    end
    
    subgraph 核心逻辑层 (n8n Workflows)
        subgraph 思考模块 (The Brain)
            F[cj-消息回复.json] -- 调用工具 --> G[飞书-图片 OCR.json]
            F -- 调用工具 --> H[MySQL 数据库]
        end

        subgraph 表达模块 (The Mouth)
            E[群聊-cj.json]
        end
    end

    subgraph 外部服务
        I[大语言模型 API<br>(Google Gemini, DeepSeek)]
        H
    end

    A -- Webhook --> B
    C -- 根据 Chat ID 分发 --> E
    E -- 触发执行 --> F
    F -- 思考结果 --> E
    E -- 格式化并调用 --> I
    E -- 最终回复 --> A
```

**架构解析:**

*   **调度层 (`机器人消息分发.json`)**: 作为系统唯一入口，负责接收所有飞书消息，并根据来源群聊 (`chat_id`) 将任务分发给对应的业务工作流。实现了环境隔离和统一调度。
*   **表达层 (`群聊-cj.json`)**: 作为面向用户的直接交互层，它负责**接收任务、响应等待、触发思考、格式化回复**。其核心是将“思考”和“表达”分离，确保了最终发送给飞书的消息格式绝对正确。
*   **思考层 (`cj-消息回复.json`)**: 这是系统的**核心大脑**。它是一个强大的 LangChain Agent，负责理解用户意图、制定计划、并行调用多种工具（数据库、OCR），并生成自然语言形式的回答草稿。
*   **工具层 (`飞书-图片 OCR.json` & MySQL Tool)**: 作为被大脑调用的“手”和“眼”，负责执行具体的、单一的任务，如识别图片文字或操作数据库。

#### **3. 核心组件与工作流详述**

##### **3.1 `机器人消息分发.json` (总调度中心)**
*   **定位**: 系统的总入口和请求路由器。
*   **核心流程**: `Webhook` 接收请求 -> `Respond to Webhook` 立即响应飞书的 Challenge -> `Switch` 节点根据 `chat_id` 将请求转发给 `群聊-cj.json` 或其他测试工作流。
*   **关键设计**:
    *   **环境隔离**: `Switch` 节点是隔离生产和测试环境的关键。
    *   **错误兜底**: 对子工作流的调用设置了 `onError`，确保在下游发生故障时，能给用户一个友好的“宕机”提示，提升了系统健壮性。

##### **3.2 `群聊-cj.json` (消息编排与格式化)**
*   **定位**: 用户体验层，负责将“思考”优美地呈现出来。
*   **核心流程**: `When Executed...` 接收调度 -> `Message:send message` 立即发送“稍等...”安抚用户 -> `Execute Workflow (问答1)` 触发“大脑”进行思考 -> “大脑”返回结果后，并行查询`家庭成员信息` -> `Merge` 整合所有信息 -> `回复消息构建1 (Agent)` 调用 **第二个AI** 将自然语言结果格式化为飞书JSON -> `Message:reply message1` 发送最终回复。
*   **关键设计**:
    *   **思考-表达分离**: 这是整个架构的点睛之笔。它避免让主 Agent 直接生成复杂的、易错的JSON，而是让一个任务更简单的 Agent 专门负责格式化，大大提高了稳定性。
    *   **即时反馈**: 先发送“稍等”，优化了用户在等待AI思考时的体验。

##### **3.3 `cj-消息回复.json` (核心大脑 - Agent)**
*   **定位**: 系统的智能核心，负责所有复杂的逻辑处理。
*   **核心流程**: `When Executed...` 接收任务和上下文 -> `Merge` 和 `Aggregate` 节点从`Base`表和`FamilyMembers`表获取静态上下文 -> `message parse (Agent)` 节点是核心，它接收用户问题和所有上下文，基于强大的System Prompt进行思考 -> Agent在思考过程中，自主决定调用`MySQL Tool`或`image OCR`工具 -> Agent最终输出自然语言形式的思考结果。
*   **关键设计**:
    *   **强大的 Agent 模型**: 采用 Google Gemini 作为主模型，保证了强大的推理和工具调用能力。
    *   **受控的工具使用**: 通过在 Prompt 中明确规定 MySQL 的使用步骤，有效约束了 AI 的行为，提高了其操作数据库的准确性。
    *   **丰富的上下文注入**: 在调用 Agent 前，已将“宝妈基础数据”、“家庭成员信息”和“当前时间”等关键动态数据注入 Prompt，为个性化回答提供了坚实基础。

##### **3.4 `飞书-图片 OCR.json` (OCR工具)**
*   **定位**: 一个独立的、可复用的、单一职责的工具。
*   **核心流程**: `When Executed...` 接收 `message_id` 和 `file_key` -> `Auth:getAccessToken` 获取飞书Token -> `HTTP Request` 下载图片文件 -> `Tesseract` 节点执行本地OCR识别 -> `Edit Fields` 格式化输出结果。
*   **关键设计**:
    *   **模块化与封装**: 将复杂的 OCR 流程封装成一个简单的工具，主“大脑”无需关心其内部实现，只需调用即可。

#### **4. 数据模型**

本系统的所有数据持久化操作均基于项目负责人提供的**《数据库使用规范文档》**。核心数据存储在本地 MySQL 的 `data` 数据库中，包含 `Base`, `FamilyMembers`, `InspectionReport`, `PregnancySchedule`, `UserRecords` 五张核心表。

#### **5. 关键技术与设计模式**
*   **Agent + Tools 架构**: 系统的核心采用了 LangChain 的 Agent 范式，赋予了 AI 调用外部工具解决复杂问题的能力。
*   **调度-执行分离模式**: 顶层工作流只负责分发，不处理业务，保证了入口的稳定和清晰。
*   **思考-表达分离模式**: 将核心逻辑思考与最终的消息格式化这两个任务，交由两个独立的 AI Agent 处理，显著提升了系统的稳定性和可维护性。
*   **模块化工具封装**: 将 OCR 等功能封装成独立的工作流工具，体现了“单一职责”和“高内聚低耦合”的优秀软件工程思想。

#### **6. 安全与配置**
*   所有敏感凭据，包括飞书 App Secret、MySQL 密码、LLM API Key，均通过 n8n 内置的 **Credentials** 功能进行安全、加密的管理，避免了硬编码风险。
*   通过 `FamilyMembers` 表中的 `role` 字段，为未来的权限控制（如只有管理员才能执行某些敏感操作）预留了设计空间。