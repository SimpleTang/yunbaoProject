## **数据库使用规范文档**

### 1. 文档引言

本数据库是孕期AI助手的核心数据中枢，旨在为特定孕妇及其家庭提供高度个性化、精准及时的孕期支持服务。所有数据的设计、存储和使用都应严格遵循**“以孕妇为中心”**的核心原则。

本文档详细描述了数据库的结构、每个表及字段的用途，并提供了标准的使用规范和常见用例，旨在为开发、运维和数据管理人员提供清晰的指导。

### 2. 数据库概览

*   **数据库名**: `data`
*   **核心设计**: 当前系统为单用户设计，所有数据表都围绕一位核心孕妇展开。
*   **数据表清单**:
    *   `Base`: 孕妇核心档案表，存储静态、基础的健康信息。
    *   `FamilyMembers`: 家庭成员信息表，管理参与互动的所有家庭成员。
    *   `InspectionReport`: 产检报告表，存储历次产检的关键结果摘要。
    *   `PregnancySchedule`: 孕期日程表，管理所有与孕期相关的事件和提醒。
    *   `UserRecords`: 用户动态记录表，捕获日常的、非结构化的动态信息，并已进行结构化增强。

### 3. 表结构详细说明

#### 3.1 `Base` - 孕妇核心档案表

*   **用途描述**: 本表是数据库的基石，存储孕妇几乎不变的核心健康档案。AI的个性化回答能力高度依赖此表的准确性。
*   **字段详情**:

| 字段名 | 类型 | 注释 | 使用规范 |
| :--- | :--- | :--- | :--- |
| `id` | int | 孕妇唯一ID | **主键**。系统所有其他数据都与此ID潜在关联。 |
| `name` | varchar(50) | 孕妇姓名 | 必须填写。 |
| `date_of_birth` | date | 出生日期 | 用于计算年龄，评估高龄等风险。 |
| `last_menstrual_period` | date | 末次月经日期 | **核心字段**。用于精确计算当前孕周。 |
| `expected_due_date` | date | 预产期 | 可由末次月经推算，也可手动录入。 |
| `blood_type` | varchar(10) | 血型 | 如 "O+", "AB-"。 |
| `height` | int | 身高(cm) | 用于计算BMI。 |
| `pre_pregnancy_weight`| decimal(5,2)| 孕前体重(kg) | 用于计算孕期总体重增长。 |
| `current_weight` | decimal(5,2)| 当前体重(kg) | 应由`UserRecords`中的体重记录动态更新至此。 |
| `hospital` | varchar(100)| 产检医院 | |
| `doctor` | varchar(50) | 主治医生 | |
| `medical_history` | text | 既往病史 | 记录高血压、糖尿病等，多个以逗号分隔。 |
| `allergy_history` | text | 过敏史 | **关键字段**。用于饮食、用药安全提醒。 |
| `medication_supplements`| text | 在服药物/补充剂| 记录叶酸、钙片等，用于设置用药提醒。 |
| `dietary_preferences`| text | 饮食偏好/禁忌 | 如素食、不吃辣等。 |
| `exercise_habits` | text | 运动习惯 | 如瑜伽、游泳等。 |
| `sleep_habits` | text | 睡眠习惯 | 如平均睡眠时长、入睡困难等。 |
| `smoking_or_drinking`| varchar(50)| 吸烟饮酒史 | |
| `notes` | text | 备注 | 其他需要记录的补充信息。 |

#### 3.2 `FamilyMembers` - 家庭成员表

*   **用途描述**: 记录家庭成员信息，用于权限区分、互动（如@成员）和紧急情况通知。
*   **字段详情**:

| 字段名 | 类型 | 注释 | 使用规范 |
| :--- | :--- | :--- | :--- |
| `id` | int | 成员ID | 主键。 |
| `name` | varchar(50) | 成员姓名 | 必须填写。 |
| `relationship` | varchar(50) | 与孕妇关系 | 如“丈夫”、“母亲”、“本人”。 |
| `feishu_id` | varchar(100)| 飞书用户ID | **核心字段**。机器人识别用户、私聊、@提醒的依据。 |
| `is_emergency_contact`| tinyint(1) | 是否紧急联系人| **关键字段**。`1`代表是，`0`代表否。**必须且只能有一位成员被设为1**。 |

#### 3.3 `InspectionReport` - 产检报告表

*   **用途描述**: 存储历次产检的核心结论，作为AI回答相关问题的权威依据。
*   **字段详情**:

| 字段名 | 类型 | 注释 | 使用规范 |
| :--- | :--- | :--- | :--- |
| `report_id` | int | 报告唯一ID | 主键。 |
| `inspection_date` | date | 检查日期 | |
| `gestational_week`| varchar(50) | 检查时孕周 | 如 "12W+3D"。 |
| `report_title` | varchar(100)| 报告标题 | 如“NT检查报告”、“大排畸超声报告”。 |
| `report_content` | text | 报告核心内容 | **只记录关键结论**，如“NT值正常”、“胎儿发育符合孕周”、“糖耐量通过”，而非上传完整报告。 |

#### 3.4 `PregnancySchedule` - 孕期日程表

*   **用途描述**: 跟踪所有孕期相关的重要日程，是“提醒与日程管理”功能的数据基础。
*   **字段详情**:

| 字段名 | 类型 | 注释 | 使用规范 |
| :--- | :--- | :--- | :--- |
| `schedule_id` | int | 日程唯一ID | 主键。 |
| `event_date` | datetime | 事件发生时间 | 精确到天或小时分钟。 |
| `event_type` | enum(...) | 事件类型 | 当前支持: `产检`, `用药`, `待办`。 |
| `event_description`| text | 事件描述 | 详细说明，如“下午2点，北医三院，大排畸检查，需空腹”。 |
| `is_completed` | tinyint(1) | 是否已完成 | `1`代表是，`0`代表否。 |

#### 3.5 `UserRecords` - 用户动态记录表

*   **用途描述**: 灵活捕捉用户通过聊天输入的各种日常信息，如体重、症状、饮食、心情等。
*   **字段详情**:

| 字段名 | 类型 | 注释 | 使用规范 |
| :--- | :--- | :--- | :--- |
| `record_id` | int | 记录唯一ID | 主键。 |
| `record_username` | varchar(50) | 记录人姓名/ID | 记录信息的人，建议存`feishu_id`以便追溯。 |
| `record_time` | datetime | 记录时间 | |
| `record_type` | enum(...) | 记录类型 | **核心分类字段**。如`weight`, `symptom`, `diet_log`, `fetal_movement`, `todo`, `image_log`。**必须填写**。 |
| `record_value` | text | 记录原始文本 | 存储用户输入的完整原文，用于展示和回顾。 |
| `value_decimal` | decimal(8,2)| 数值记录(小数)| 当`record_type`为`weight`时，将体重数值（如65.5）存入此字段。 |
| `value_int` | int | 数值记录(整数)| 当`record_type`为`fetal_movement`时，将胎动次数存入此字段。 |
| `status` | varchar(50) | 状态 | 用于`todo`等类型，标记“未开始”、“进行中”、“已完成”。 |
| `notes` | text | 备注 | |
| `source` | varchar(50) | 记录来源 | 如`group_chat`, `private_chat`。 |

### 4. 常见核心用例

#### 用例1：记录一次体重
*   **场景**: 孕妇或家人在群里发送：“@机器人 `记录体重：68.2kg`”。
*   **数据库操作**:
    1.  AI机器人解析消息，提取到记录类型为`weight`，数值为`68.2`。
    2.  向`UserRecords`表插入一条新记录：
        ```sql
        INSERT INTO UserRecords 
        (record_username, record_time, record_type, record_value, value_decimal, source) 
        VALUES 
        ('[发送者feishu_id]', NOW(), 'weight', '记录体重：68.2kg', 68.2, 'group_chat');
        ```
    3.  （可选）更新`Base`表中的`current_weight`字段：
        ```sql
        UPDATE Base SET current_weight = 68.2 WHERE id = 1;
        ```

#### 用例2：回答个性化问题
*   **场景**: 家人提问：“@机器人 洁洁（孕妇名）现在能吃螃蟹吗？”
*   **数据库操作 (均为`SELECT`)**:
    1.  **查询过敏史**: `SELECT allergy_history FROM Base WHERE name = 'xx';`
    2.  **查询近期不适**: `SELECT record_value FROM UserRecords WHERE record_type = 'symptom' AND record_time >= DATE_SUB(NOW(), INTERVAL 3 DAY);`
    3.  **查询医生特别嘱咐**: `SELECT notes FROM Base;` 或 `SELECT event_description FROM PregnancySchedule WHERE event_description LIKE '%螃蟹%';`
    4.  AI综合以上信息（如：过敏史不含螃蟹，但近期有“腹泻”记录），生成回答：“档案显示xx对螃蟹不过敏，但考虑到她昨天记录有轻微腹泻，建议今天先避免食用寒性的螃蟹，观察一下身体状况。如果想吃，建议少量尝试并确保彻底煮熟。”

#### 用例3：触发紧急情况警报
*   **场景**: 孕妇在私聊或群里发送了“救命”、“破水了”等关键词。
*   **数据库操作 (均为`SELECT`)**:
    1.  AI识别到高危关键词。
    2.  **立即查询紧急联系人**:
        ```sql
        SELECT name, feishu_id FROM FamilyMembers WHERE is_emergency_contact = 1;
        ```
    3.  AI使用查询到的`feishu_id`和`name`，立即通过飞书急信、电话等方式发送警报通知。

### 5. 数据管理最佳实践

1.  **保持数据一致性**: 录入新成员时，确保`feishu_id`的准确性。在`UserRecords`中，`record_username`应使用`feishu_id`。
2.  **维护单一数据源**: 重要的、结构化的信息应存放在其专属的表中。例如，一次正式的产检结果必须记录在`InspectionReport`，而不是随意地记在`UserRecords`。
3.  **结构化优先**: 对于可结构化的数据（如体重、胎动次数），务必使用`record_type`进行分类，并将数值填入`value_decimal`或`value_int`字段，而不是仅仅存为文本。
4.  **数据隐私**: 所有数据均为高度敏感的个人健康信息，系统在设计和开发中必须建立严格的权限控制，防止数据泄露。
5.  **定期备份**: 对数据库进行定期的、可靠的备份。