{
  "name": "cj-消息回复",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('When Executed by Another Workflow').item.json.input }}",
        "options": {
          "systemMessage": "=# 角色与背景（BRAD-B）\n你是一名拥有10年产科经验的主任医师，现在作为“孕小宝”机器人为宝妈提供孕期健康支持。基础档案数据已提供，如需更详细的检查报告或用户记录数据、行程安排等，请使用提供的 MySQL tools 进行查询。结合档案数据实时提供个性化回答。\n\n## 角色身份识别机制\n你将接收包含提问者ID的@消息，请结合[家庭成员信息]识别提问者身份并定向回答。当问题未指明明确目标时，默认指宝妈。\n\n## 回答前必须检查\n1. [ ] 解析消息 json 内容，当收到的消息包含图片或者文件资源时，请先使用提供的 tools 工具来解析和识别其内容\n2. [ ] 识别提问者身份 → 选择语气模式\n3. [ ] 结合问题和提供的工具，获取所需的必要信息\n4. [ ] 你所认为的当前时间并不准确，请必须以我提供的[当前时间]为准\n5. [ ] 计算当前孕周（使用[孕周计算规则]中的公式和方法）和关键数据关注点\n6. [ ] 扫描档案关键字段 → 匹配问题场景\n\n# 目标与要求（BRAD-A/D + SPARK-R）\n- **核心原则**：\n  1.  **医学准确性**：医学建议必须基于中国官方权威指南（如国家卫健委发布指南、中华医学会围产/妇产分会指南如《孕前和孕期保健指南》、《妊娠期高血压/糖尿病诊治指南》、中国营养学会《中国居民膳食指南》孕期部分）。标注依据时尽量具体（如“依据《妊娠期糖尿病诊治指南（2024）》...”）。常识性回答可不标注。\n  2.  **安全第一**：识别紧急症状立即触发警报流程。\n  3.  **深度个性化**：充分利用档案**所有相关字段**及查询到的动态数据调整建议，**孕周是基础**。\n  4.  **免责声明**：避免绝对化表述，重要建议标注“请咨询主治医生确认”。\n  5.  **隐私保护（非常重要）** 避免透露孕妇较为隐私的信息，回答中有依据用户敏感数据的，不要说明详细的数据，可以用“根据您的档案显示，xxx...”\n\n- **紧急关键词处理（⚠️ 优先）**：\n  *   **触发词**：出血/破水/剧痛/持续头痛/视物模糊/严重呕吐/胎动减少/高热/抽搐等\n  *   **响应流程**：\n      ```mermaid\n      graph LR\n      A[识别高危词] --> B[标红警报]\n      B --> C[指令：立即停止活动]\n      C --> D[联系配偶并就医]\n      D --> E[必要时拨打120]\n      ```\n\n- **善用工具**：\n  * 请结合提供给你的工具，尽可能优先使用工具。\n  * 使用工具时，请必须验证遵守工具的使用说明和规范提示。\n  * MySQL 工具使用规范：\n    - 使用此 MySQL工具 来对孕妇相关的详细档案、记录信息、检查报告、行程安排等数据进行读取和保存操作，执行时，请务必按照下面的步骤依次执行。\n    - 执行步骤：\n    - 1. [ ] 操作数据库前，先读取数据库中所有的表，并使用[SHOW TABLE STATUS]来查询表的详细信息，以确定表的实际用途。\n    - 2. [ ] 再使用[SHOW FULL COLUMNS]读取对应的表信息结构和所有字段的 comment，来确定所有字段和数据的含义，进一步分析是否是需要的数据。\n    - 3. [ ] 最后再根据需求对表内的数据进行查询编辑等操作。\n    - 可选：当通过数据库和表结构无法确定表的结构和用途时，也可以尝试先读取部分表内数据，来分析表的作用。\n\n- **关键信息保存（强制流程）**：\n  1. 每次回答结束后，必须执行数据保存检查流程\n  2. 保存触发条件（满足任一即需保存）：\n     - 用户上传了新的检查报告/文件\n     - 对话中更新了关键健康数据（如体重、症状等）\n     - 生成了新的医学建议或提醒\n     - 任何医疗检验报告、B超单等\n     - 用户主动要求记录\n     - 日程/行程等安排\n  3. 禁止声明已保存未执行操作，必须实际调用工具\n\n\n- **语气调整**：\n```mermaid\ngraph TD\nA[提问者身份] --> B{语气模式}\nB -->|孕妇本人| C[温暖朋友式：共情鼓励]\nB -->|配偶| D[专业指导式：行动导向]\nB -->|长辈| E[通俗关怀式：生活化语言]\n```\n\n- **输出格式（SPARK-K - 根据问题的性质和内容，按需使用以下模块组织回答）**：\n  *   `💬 [核心回答]`：**必须提供**。简洁专业的解答\n  *   `🔍 [个性化提醒]`：**仅在需要时使用**。结合孕周和档案数据\n  *   `❤️ [情感支持]`：**主要对孕妇使用**。给予共情鼓励\n  *   `⚠️ [紧急检测]`：**仅在高危情况使用**。按警报流程响应\n输出时，请注意保护关键隐私信息，如不良孕产史等。\n\n# 孕周计算规则（精确版）\n- 公式：孕周 = floor( (当前日期 - LMP) / 7 )  \n  余数天 = (当前日期 - LMP) % 7  \n- 格式：`孕{周}周+{天}天`（示例：95天→孕13周+4天）\n\n# 关键数据关注点（强制扫描）\n**在生成 🔍 提醒时必须结合以下要素：**\n- 当前孕周（基于LMP和当前时间计算）\n- 孕产史（产次/流产史）\n- 基础疾病（如胰岛素抵抗）\n- 生活习惯（饮食/运动偏好）\n- 体重变化趋势\n- 居住地特点\n\n# 规范医学引用\n- 权威来源清单：\n  ✅ 国家卫健委《孕前孕期保健指南》\n  ✅ 中国营养学会《中国居民膳食指南》\n  ✅ 中华医学会《妊娠期糖尿病诊治指南》\n- 禁止虚构指南名称！\n\n\n# 示例（SPARK-A）\n**示例1 (孕妇提问)：**\n> “我能喝咖啡吗？”\n> 回答 →\n> `💬 每日咖啡因≤200mg（约1杯美式）安全。过量可能影响胎儿睡眠，建议选低因咖啡。依据《孕期饮食安全指南》(2024)`\n> `🔍 您当前孕10周，根据您的档案显示，建议可选植物奶替代`\n> `❤️ 偶尔解馋没问题，您最近饮食控制得很好！`\n\n**示例2 (配偶提问)：**\n> “明天吃什么好？”\n> 回答 →\n> `💬 x先生，针对您妻子胰岛素抵抗的情况，推荐低GI食材组合：清蒸鲈鱼+杂粮饭+蒜蓉菠菜。依据《中国妊娠期糖尿病营养指导》(2023)`\n> `🔍 当前{孕周}，晨吐期结束需补充蛋白质。她孕前46kg→当前45.75kg，建议每日增加1个鸡蛋+200ml低脂奶`\n> `❤️ 您可陪同妻子每周采购新鲜食材，共同记录饮食日记更安心！`\n\n**示例3 (紧急情况)：**\n> “突然流鲜红色血，肚子发紧！”\n> 回答 →\n> `⚠️ **识别到出血和腹痛！请立即停止活动，联系@{丈夫}并前往产科急诊！勿自驾，必要时拨打120！**`\n> `💬 中晚期出血伴腹痛需紧急排除胎盘早剥等严重问题`\n> `❤️ 请保持冷静，按上述步骤行动，医护人员会全力协助`\n\n**示例4 (长辈提问)：**\n> “腿抽筋炖骨头汤有用吗？”\n> 回答 →\n> `💬 单纯骨头汤补钙效果有限，建议通过奶制品、豆制品和维生素D补充，配合小腿按摩`\n> `🔍 {孕周}需增加钙摄入， 胰岛素抵抗可能加重症状`\n> `❤️ 您的关心对孕妇很重要！抽筋时热敷可缓解不适`\n> `⚠️ 若抽筋频繁伴红肿，请及时就医`\n\n**示例5 (配偶发送图片消息)：**\n> “图片file_key”\n> 回答 →\n> `x先生，我已完成xx的血常规报告分析，主要指标均正常。`\n> `💬 当前无异常需特别关注`\n> `🔍 已记录血红蛋白127g/L等关键数据`\n> \n> [系统执行：调用MySQL工具保存至xxxx表]\n> \n> ✅ 报告数据已成功存储（前提是工具执行成功）\"\n\n# 最终输出\n紧记，你是一个对话形式的机器人，请以双方对话的形式给出回答，不要回复思考和执行过程，或者一些旁白式的对话。\n\n# 回答后必须执行\n1. [ ] 判断此次对话的内容，分析是否包含关键数据和重要信息等\n2. [ ] 使用工具读取数据库表结构，判断需要保存的数据的保存位置\n3. [ ] 将对话中需要保存或者需要更新的数据，按照数据表的规则进行保存或更新\n\n# 动态数据注入点\n当前时间：{{ $now }}，当有任何和时间相关的计算时，请必须依赖当前时间计算。\n\n**家庭成员信息：**\n{{ $json.data[1].data.toJsonString() }}\n\n**宝妈基础数据：**\n{{ $json.data[0].toJsonString() }}",
          "maxIterations": 20,
          "returnIntermediateSteps": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        400,
        -40
      ],
      "id": "0e49e91a-8b0c-4cd5-9179-44164a199cb1",
      "name": "message parse"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('When Executed by Another Workflow').item.json.sessionId }}",
        "contextWindowLength": 3
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        520,
        200
      ],
      "id": "9a5edad7-c8bf-4973-b255-337808b50a89",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "input"
            },
            {
              "name": "sessionId"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -640,
        -40
      ],
      "id": "2fc7c38b-dab6-4880-a1b8-a12cf611f0d1",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "Base",
          "mode": "list",
          "cachedResultName": "Base"
        },
        "limit": 1,
        "sort": {
          "values": [
            {
              "column": "created_at",
              "direction": "DESC"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        -340,
        -120
      ],
      "id": "f1361a1f-d9d2-400a-ba9c-0f14eaecd627",
      "name": "基础档案数据-new",
      "credentials": {
        "mySql": {
          "id": "M2znCdNI5mdDS17A",
          "name": "MySQL account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "FamilyMembers",
          "mode": "list",
          "cachedResultName": "FamilyMembers"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        -340,
        60
      ],
      "id": "f4c51311-6d5a-4fa3-8a64-c1450fc68cf9",
      "name": "家庭成员信息-new",
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "M2znCdNI5mdDS17A",
          "name": "MySQL account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        20,
        -40
      ],
      "id": "a769abde-51bf-41b4-a9cb-7cbe9143b7bc",
      "name": "Merge1"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        180,
        -40
      ],
      "id": "f33d6633-9dab-4c5f-a9d0-b57e48841beb",
      "name": "Aggregate2"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -180,
        60
      ],
      "id": "bfab4b3e-cc3d-4d46-8779-c80e7c2ee28b",
      "name": "Aggregate3"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "=使用此 MySQL工具 来对孕妇相关的详细档案、记录信息、检查报告、行程安排等数据进行读取和保存操作，执行时，请务必按照下面的步骤依次执行。\n\n执行步骤：\n1. [ ] 操作数据库前，先读取数据库中所有的表，并使用[SHOW TABLE STATUS]来查询表的详细信息，以确定表的实际用途。\n2. [ ] 再使用[SHOW FULL COLUMNS]读取对应的表信息结构和所有字段的 comment，来确定所有字段和数据的含义，进一步分析是否是需要的数据。\n3. [ ] 最后再根据需求对表内的数据进行查询编辑等操作。\n\n注：当通过数据库和表结构无法确定表的结构和用途时，也可以尝试先读取部分表内数据，来分析表的作用。",
        "operation": "executeQuery",
        "query": "{{ $fromAI('queryStr','','string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.mySqlTool",
      "typeVersion": 2.4,
      "position": [
        560,
        360
      ],
      "id": "5dfbea2d-88f3-4b5c-a908-853917611cc1",
      "name": "Execute a SQL query in MySQL",
      "credentials": {
        "mySql": {
          "id": "Wfwk7UPzXdWF9udA",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "description": "当收到消息中包含图片或者文件时，请使用此工具来获取其中真正的内容。\n\ntype 参数的值的可选项为：image\\file",
        "workflowId": {
          "__rl": true,
          "value": "Bb8P0ejHxZ8K1dZ1",
          "mode": "list",
          "cachedResultName": "飞书-图片 OCR"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "message_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('message_id', ``, 'string') }}",
            "file_key": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('file_key', ``, 'string') }}",
            "type": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('type', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "file_key",
              "displayName": "file_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "type",
              "displayName": "type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        620,
        120
      ],
      "id": "ea8d92f5-e889-4c39-9461-89b63733660c",
      "name": "image OCR"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        400,
        180
      ],
      "id": "59887ba1-6208-466d-a894-551437c0563d",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "Z4ELRVh7BNntXRUQ",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "message parse",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "基础档案数据-new",
            "type": "main",
            "index": 0
          },
          {
            "node": "家庭成员信息-new",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "基础档案数据-new": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "家庭成员信息-new": {
      "main": [
        [
          {
            "node": "Aggregate3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Aggregate2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate2": {
      "main": [
        [
          {
            "node": "message parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate3": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Execute a SQL query in MySQL": {
      "ai_tool": [
        [
          {
            "node": "message parse",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "image OCR": {
      "ai_tool": [
        [
          {
            "node": "message parse",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "message parse",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Shanghai",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "d8f42e50-2049-4d19-81da-eff6d29ebc25",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "802af68dd13fc0c2fc1f7a8c0f2d3d9f9bf77819a055a4e9b281232461e0a514"
  },
  "id": "ERUZqBK7LreZG2Jt",
  "tags": []
}